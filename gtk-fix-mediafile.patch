From e290f678912fbd642d756bc3bfc73ecca8c42966 Mon Sep 17 00:00:00 2001
From: Ivan Molodetskikh <yalterz@gmail.com>
Date: Thu, 13 May 2021 23:08:40 +0300
Subject: [PATCH] gtkgstmediafile: Ignore first media info with 0 duration

Hotfix for https://gitlab.gnome.org/GNOME/gtk/-/issues/3914 to make
GtkMediaFile's duration work.
---
 modules/media/gtkgstmediafile.c | 18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

diff --git a/modules/media/gtkgstmediafile.c b/modules/media/gtkgstmediafile.c
index b5b1d772b0..32756177c3 100644
--- a/modules/media/gtkgstmediafile.c
+++ b/modules/media/gtkgstmediafile.c
@@ -31,6 +31,7 @@ struct _GtkGstMediaFile
 
   GstPlayer *player;
   GdkPaintable *paintable;
+  gboolean seen_media_info;
 };
 
 struct _GtkGstMediaFileClass
@@ -175,7 +176,21 @@ gtk_gst_media_file_media_info_updated_cb (GstPlayer          *player,
                                           GstPlayerMediaInfo *media_info,
                                           GtkGstMediaFile    *self)
 {
-  gtk_gst_media_file_ensure_prepared (self);
+  /* GstPlayer frequently sends the first media-info-updated signal just before
+   * it has got the duration. Calling ensure_prepared() right away means we will
+   * be stuck with duration = 0 (and no seeking). As a hotfix, don't prepare
+   * the media file if it's the first media-info-updated and the duration is 0.
+   *
+   * See https://gitlab.gnome.org/GNOME/gtk/-/issues/3914
+   * See https://gitlab.freedesktop.org/gstreamer/gst-plugins-bad/-/issues/1588
+   */
+  if (self->seen_media_info ||
+      gst_player_media_info_get_duration (media_info) != 0)
+    {
+      gtk_gst_media_file_ensure_prepared (self);
+    }
+
+  self->seen_media_info = TRUE;
 }
 
 static void
@@ -232,6 +247,7 @@ gtk_gst_media_file_destroy_player (GtkGstMediaFile *self)
   g_signal_handlers_disconnect_by_func (self->player, gtk_gst_media_file_error_cb, self);
   g_object_unref (self->player);
   self->player = NULL;
+  self->seen_media_info = FALSE;
 }
 
 static void
-- 
GitLab

